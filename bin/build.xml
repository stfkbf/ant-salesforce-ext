<project name="Sample usage of Salesforce Ant tasks" default="generatePackage" basedir="." xmlns:sf="antlib:com.salesforce">

    <property file="build.properties.${branch}"/>
    <property environment="env"/>
    
    <taskdef name="generatePackage" classname="dk.stfkbf.GeneratePackageOrg" >
     <classpath>
      <fileset dir="lib">
        <include name="**/*.jar"/>
      </fileset>
    </classpath>
    </taskdef>

    <taskdef name="generatePackageFileset" classname="dk.stfkbf.GeneratePackageFileset" >
     <classpath>
      <fileset dir="lib">
        <include name="**/*.jar"/>
      </fileset>
    </classpath>
    </taskdef>

    <taskdef name="buildFileset" classname="dk.stfkbf.BuildFileset" >
     <classpath>
      <fileset dir="lib">
        <include name="**/*.jar"/>
      </fileset>
    </classpath>
    </taskdef>

    <taskdef name="prepareFileset" classname="dk.stfkbf.PrepareFileset" >
     <classpath>
      <fileset dir="lib">
        <include name="**/*.jar"/>
      </fileset>
    </classpath>
    </taskdef>

    <taskdef name="deleteFromGit" classname="dk.stfkbf.DeleteFromGit" >
     <classpath>
      <fileset dir="lib">
        <include name="**/*.jar"/>
      </fileset>
    </classpath>
    </taskdef>
    
    <taskdef resource="org/eclipse/jgit/ant/ant-tasks.properties">
       <classpath>
         <pathelement location="lib/org.eclipse.jgit-3.3.0.201403021825-r.jar"/>
         <pathelement location="lib/org.eclipse.jgit.ant-3.3.0.201403021825-r.jar"/>         
       </classpath>
   </taskdef>

   <taskdef name="forceDiff" classname="dk.stfkbf.ForceDiff" >
     <classpath>
      <fileset dir="lib">
        <include name="**/diff_match_patch-current.jar"/> 
        <include name="**/commons-io-2.4.jar"/> 
        <include name="**/force-metadata-api-30.0.0.jar"/> 
        <include name="**/force-wsc-31.0.0.jar"/>        
        <include name="**/salesforce-package.jar"/>
      </fileset>
    </classpath>
   </taskdef>

   <taskdef uri="antlib:com.salesforce" resource="com/salesforce/antlib.xml" classpath="lib/ant-salesforce-30.jar"/>

   <target name="generatePackage">
      <generatePackage username="${sf.username}" 
   		       password="${sf.password}" 
      		       authEndpoint="https://login.salesforce.com/services/Soap/u/30.0" 
      		       outputPath="${package.output}" />
    </target>

    <target name="retrieve">
      <delete includeemptydirs="true">  
        <fileset dir="${git.temp}" includes="**/*"/>  
      </delete>  

      <sf:retrieve username="${sf.username}" 
    		   password="${sf.password}" 
    		   serverurl="${sf.serverurl}" 
    		   maxPoll="${sf.maxPoll}" 
    		   retrieveTarget="${git.temp}" 
    		   unpackaged="package.xml"/>
    </target>
    
    <target name="moveToGit">
       <deleteFromGit sourcePath="${git.temp}" 
        	      targetPath="${git.source}" 
      		      gitRoot="${git.root}" />
	  <copy todir="${git.source}">
        <fileset dir="${git.temp}"/>
      </copy>      				 
    </target>

    <target name="switchBranch">
	  <git-checkout src="${git.root}" branch="${branch}" />
    </target>
        
    <target name="extractBranch">
	  <git-checkout src="${git.root}" branch="${branch}" />
	      
      <generatePackage username="${sf.username}" 
      	               password="${sf.password}" 
      		       authEndpoint="https://login.salesforce.com/services/Soap/u/30.0" 
      		       outputPath="${package.output}" />
      				       
      <delete includeemptydirs="true">  
        <fileset dir="${git.temp}" includes="**/*"/>  
	  </delete>  
	  
      <sf:retrieve username="${sf.username}" 
      			   password="${sf.password}" 
      			   serverurl="${sf.serverurl}" 
      			   maxPoll="${sf.maxPoll}" 
      			   retrieveTarget="${git.temp}" 
      			   unpackaged="package.xml"/>      				       
      				       
      <deleteFromGit sourcePath="${git.temp}" 
      	             targetPath="${git.source}" 
      		     gitRoot="${git.root}" />
      				   
	  <copy todir="${git.source}">
        <fileset dir="${git.temp}"/>
      </copy>      				 
    </target>
    
    <target name="createPackage">
     
      <delete includeemptydirs="true">  
        <fileset dir="${git.temp}" includes="**/*"/>  
      </delete>  

      <delete includeemptydirs="true">  
        <fileset dir="${git.output}" includes="**/*"/>  
      </delete>  

      <delete includeemptydirs="true">  
        <fileset dir="${git.root}" includes="**/*.orig"/>  
      </delete>  

      <generatePackage username="${sf.username}" 
      		       password="${sf.password}" 
      		       authEndpoint="https://login.salesforce.com/services/Soap/u/30.0" 
      		       outputPath="${git.temp}" />
      				       	  
      <sf:retrieve username="${sf.username}" 
      			   password="${sf.password}" 
      			   serverurl="${sf.serverurl}" 
      			   maxPoll="${sf.maxPoll}" 
      			   retrieveTarget="${git.temp}" 
      			   unpackaged="package.xml"/>  
      
      <forceDiff sourceDir="${git.source}" targetDir="${git.temp}" outputDir="${git.output}" metadataTypes="all" />

      <forceDiff sourceDir="${git.source}" targetDir="${git.temp}" outputDir="${git.output.ms}" metadataTypes="milestoneTypes" />

      <prepareFileset filesetPath="${git.output.source}" 
      		      targetPath="${git.temp}"
                      properties="prepareFileset.properties" />


      <generatePackageFileset username="${sf.username}" 
      			      password="${sf.password}" 
      			      authEndpoint="https://login.salesforce.com/services/Soap/u/30.0" 
      			      outputPath="${git.output.source}" 
      			      repositoryPath="${git.output.source}"/>
      
    </target>

    <target name="generatePackageFileset">
      <generatePackageFileset username="${sf.username}" 
      			      password="${sf.password}" 
      			      authEndpoint="https://login.salesforce.com/services/Soap/u/30.0" 
      			      outputPath="${git.output.source}" 
      						repositoryPath="${git.output.source}"/>
    </target>

    <target name="cleanup">
      <delete includeemptydirs="true">  
        <fileset dir="${git.root}" includes="**/*.orig"/>  
	  </delete>  
    </target>
    
    <target name="deployToOrg">
      <sf:deploy username="${sf.username}" 
      			 password="${sf.password}" 
      			 serverurl="${sf.serverurl}" 
      			 maxPoll="${sf.maxPoll}" 
      			 deployRoot="${git.output.ms}/upsert"/>
     <sf:deploy username="${sf.username}" 
      			 password="${sf.password}" 
      			 serverurl="${sf.serverurl}" 
      			 maxPoll="${sf.maxPoll}" 
      			 deployRoot="${git.output}/upsert"/>
      <sf:deploy username="${sf.username}" 
      			 password="${sf.password}" 
      			 serverurl="${sf.serverurl}" 
      			 maxPoll="${sf.maxPoll}" 
      			 deployRoot="${git.output}/delete"/>
    </target>

</project>
